@model Tuple<IEnumerable<Order>, IEnumerable<Order>>

@{
    ViewData["Title"] = "Orders";
}

@section Styles
{
    <link rel="stylesheet" href="~/assets/plugins/datatables.bundle.css" />
}

<div class="alert bg-light-primary border border-primary border-3 border-dashed d-flex justify-content-between w-100 p-5 mb-10">
    <div class="d-flex align-items-center">
        <div class="symbol symbol-40px me-4">
            <div class="symbol-label fs-2 fw-semibold text-success">
                <!--begin::Svg Icon | path: icons/duotune/general/gen002.svg-->
                <span class="svg-icon svg-icon-2 svg-icon-primary">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path opacity="0.3" d="M21.25 18.525L13.05 21.825C12.35 22.125 11.65 22.125 10.95 21.825L2.75 18.525C1.75 18.125 1.75 16.725 2.75 16.325L4.04999 15.825L10.25 18.325C10.85 18.525 11.45 18.625 12.05 18.625C12.65 18.625 13.25 18.525 13.85 18.325L20.05 15.825L21.35 16.325C22.35 16.725 22.35 18.125 21.25 18.525ZM13.05 16.425L21.25 13.125C22.25 12.725 22.25 11.325 21.25 10.925L13.05 7.62502C12.35 7.32502 11.65 7.32502 10.95 7.62502L2.75 10.925C1.75 11.325 1.75 12.725 2.75 13.125L10.95 16.425C11.65 16.725 12.45 16.725 13.05 16.425Z" fill="currentColor" />
                        <path d="M11.05 11.025L2.84998 7.725C1.84998 7.325 1.84998 5.925 2.84998 5.525L11.05 2.225C11.75 1.925 12.45 1.925 13.15 2.225L21.35 5.525C22.35 5.925 22.35 7.325 21.35 7.725L13.05 11.025C12.45 11.325 11.65 11.325 11.05 11.025Z" fill="currentColor" />
                    </svg>
                </span>
                <!--end::Svg Icon-->
            </div>
        </div>
        <!--begin::Content-->
        <div class="d-flex flex-column pe-0 pe-sm-10">
            <h5 class="mb-1">Orders</h5>
        </div>
        <!--end::Content-->
    </div>
    <div>
        <a href="javascript:;" class="btn btn-sm btn-primary js-render-modal"
           data-title="Add Order" data-url="/Orders/Create">
            <i class="bi bi-plus-square-dotted"></i>
            Add
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <div class="separator"></div>
        <!--begin::Nav-->
        <ul class="nav nav-stretch nav-line-tabs nav-line-tabs-2x border-transparent fs-5 fw-bold">
            <!--begin::Nav item-->
            <li class="nav-item">
                <a class="nav-link text-active-primary py-5 me-6 active" data-bs-toggle="tab" href="#pending">Pending Orders</a>
            </li>
            <!--end::Nav item-->
            <!--begin::Nav item-->
            <li class="nav-item">
                <a class="nav-link text-active-primary py-5 me-6" data-bs-toggle="tab" href="#completed">Completed Orders</a>
            </li>
            <!--end::Nav item-->
        </ul>
        <!--end::Nav-->
    </div>
    <div class="card-body">
        <div class="tab-content">
            <!-- Pending Orders Tab -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                <div class="table-responsive">
                    <table id="pendingOrdersTable" class="table table-row-dashed table-row-gray-300 gy-2 align-middle" data-document-title="Pending Orders">
                        <thead>
                            <tr class="fw-bold fs-6 text-gray-800">
                                <th>Request Date</th>
                                <th>Fulfilled Date</th>
                                <th>Status</th>
                                <th>Beneficiary</th>
                                <th>Warehouse</th>

                                <th class="js-no-export">Operations</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.Item1) // Pending orders
                            {
                                <tr data-order-id="@order.OrderId">
                                    <td>@order.RequestDate</td>
                                    <td>@order.FulfilledDate</td>
                                    <td class="js-status">@order.Status</td>
                                    <td>@order.BeneficiaryId</td>
                                    <td>@order.WarehouseId</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style=" color: white; border: none; border-radius: 5px; padding: 10px;">
                                                <i class="fa-solid fa-cog"></i>
                                                <span class="caret" style="color: black;"></span>
                                            </button>

                                            <ul class="dropdown-menu" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                                                <li>
                                                    <a class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-primary js-render-modal"
                                                       href="javascript:;"
                                                       data-title="Edit Order"
                                                       data-url="/Orders/Edit/@order.OrderId" data-update="true"
                                                       style="transition: background-color 0.3s; padding: 8px 12px; display: block; text-align: center; border-radius: 5px;">
                                                        Edit
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item js-toggle-status-order btn btn-sm btn-outline btn-outline-dashed btn-active-light-primary"
                                                       href="javascript:;"
                                                       data-url="/Orders/ChangeStatus/@order.OrderId"
                                                       data-id="@order.OrderId"
                                                       style="padding: 10px;"
                                                       data-id="@order.OrderId">
                                                        Toggle Status
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Completed Orders Tab -->
            <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
                <div class="table-responsive">
                    <table id="completedOrdersTable" class="table table-row-dashed table-row-gray-300 gy-2 align-middle" data-document-title="Completed Orders">
                        <thead>
                            <tr class="fw-bold fs-6 text-gray-800">
                                <th>Request Date</th>
                                <th>Fulfilled Date</th>
                                <th>Status</th>
                                <th>Beneficiary</th>
                                <th>Warehouse</th>

                                <th class="js-no-export">Operations</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.Item2) // Completed orders
                            {
                                <tr>
                                    <td>@order.RequestDate</td>
                                    <td>@order.FulfilledDate</td>
                                    <td>@order.Status</td>
                                    <td>@order.BeneficiaryId</td>
                                    <td>@order.WarehouseId</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style=" color: white; border: none; border-radius: 5px; padding: 10px;">
                                                <i class="fa-solid fa-cog"></i>
                                                <span class="caret" style="color: black;"></span>
                                            </button>

                                            <ul class="dropdown-menu" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                                                <li>
                                                    <a class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-primary js-render-modal"
                                                       href="javascript:;"
                                                       data-title="Edit Order"
                                                       data-url="/Orders/Edit/@order.OrderId" data-update="true"
                                                       style="transition: background-color 0.3s; padding: 8px 12px; display: block; text-align: center; border-radius: 5px;">
                                                        Edit
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Plugins {
    <script src="~/assets/plugins/datatables.bundle.js"></script>
}

@section Scripts {
    <script>

                    $(document).ready(function () {

            // Handle click event for the toggle status button with SweetAlert confirmation
            $('body').delegate('.js-toggle-status-order', 'click', function () {
                debugger
                var btn = $(this);

                // Show SweetAlert confirmation dialog
                Swal.fire({
                    title: "Are you sure you need to toggle this item status?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, change it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Perform the AJAX request to change the status
                        $.post({
                            url: btn.data('url'),  // Get the URL for the status toggle
                            type: 'post',
                            data: {
                                '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()  // Anti-CSRF token
                            },
                            success: function (lastUpdatedOn) {
                                debugger
                                // On success, find the corresponding row
                                var row = btn.parents('tr');
                                var status = row.find('.js-status');  // The element displaying the status
                         var statusText = status.text().trim();  // This should now work if the text is properly set

                        if (!statusText) {
                            console.error('Status text is empty!');
                            return;
                        }
                                var newStatus = status.text().trim() === 'Pending' ? 'Completed' : 'Pending';  // Toggle status

                                // Update the status text and classes for visual indication
                                status.text(newStatus).toggleClass('badge-light-success badge-light-danger');

                                // Update the last updated timestamp
                                row.find('.js-updated-on').html(lastUpdatedOn);

                                // Move the row to the appropriate table
                                if (newStatus === 'Completed') {
                                    // Move row to the completed orders table
                                    row.appendTo('#completedOrdersTable tbody');
                                } else {
                                    // Move row back to the pending orders table
                                    row.appendTo('#pendingOrdersTable tbody');
                                }

                                // Show success message (You can customize this method)
                                ShowSuccessMessage();
                            },
                            error: function () {
                                // Show error message if something goes wrong
                                ShowErrorMessage();
                            }
                        });
                    }
                });
            });
        });

       


    </script>
}
